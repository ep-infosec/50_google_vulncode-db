<template id="product-search-template">
<v-app>
  <v-main>
    <v-autocomplete
        v-bind:value="internalProducts"
        v-on:change="$emit('change', $event)"
        :loading="loading"
        :items="internalItems"
        @input="search=null"
        :search-input.sync="search"
        :filter="customFilter"
        class="mx-4"
        flat
        hide-details
        dense
        filled
        :item-value="toValue"
        label="Which products are affected?"
        chips
        multiple
        clearable
        :attach="true"
        :close-on-click="false"
    >
        <template v-slot:selection="data">
            <v-chip
                    v-bind="data.attrs"
                    :input-value="data.selected"
                    close
                    @click:close="remove(data.item)"
            >
                <b>[[ data.item.product ]]</b>&nbsp; (by [[ data.item.vendor ]])
            </v-chip>
        </template>
        <template v-slot:item="data">
            <template v-if="typeof data.item !== 'object'">
                <v-list-item-content v-text="data.item"></v-list-item-content>
            </template>
            <template v-else>
                <v-list-item-content>
                    <v-list-item-title v-html="highlightText(data.item.product)"></v-list-item-title>
                    <v-list-item-subtitle v-html="'by ' + data.item.vendor"></v-list-item-subtitle>
                </v-list-item-content>
            </template>
        </template>
    </v-autocomplete>
  </v-main>
</v-app>
</template>
<div id="product-search"></div>
<div id="product-fields"></div>

{# // https://github.com/mdn/interactive-examples/issues/887 and https://bugs.chromium.org/p/chromium/issues/detail?id=336876 #}
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900">

<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
<script src="{{ url_for('frontend.serve_static', path='js/product_search.js') }}"></script>
<script>
selectedProducts = [
    {%- for vendor, product in vuln_view.products %}
    {product: {{product|tojson}}, vendor: {{vendor|tojson}}},
    {%- endfor %}
];
new Vue({
  render: h => h(ProductSearch, {
    props: {
      products: selectedProducts,
    },
    on: {
      'change': (event) => {
        selectedProducts = event.map(p => {
            const [vendor, product] = p.split('#~#');
            return {vendor, product};
        });
      }
    }
  }),
  el: holder,
  vuetify: new Vuetify(),
  delimiters: ['[[', ']]'],
});
</script>
